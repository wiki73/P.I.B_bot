from aiogram import Bot, Dispatcher, types
from aiogram import F
import asyncio
from aiogram.types import Message
from aiogram.filters import CommandStart, Command
from database import create_tables, get_user_name, save_user_name, get_user_plan, save_user_plan

# Замените 'YOUR_BOT_TOKEN' на токен, полученный от @BotFather
TOKEN = '7947948717:AAF_yeOpDDLoOCrTUWQRzb_akKx05xWpNVU'

# Инициализация бота и диспетчера
bot = Bot(token=TOKEN)
dp = Dispatcher()

# Создание таблиц пользователей и планов
create_tables()


# Обработчик команды /start
@dp.message(Command('start'))
async def start_command(message: types.Message):
    user_id = message.from_user.id
    user_name = get_user_name(user_id)
    
    if user_name is None:
        await message.reply('Еу. Я твой бот для рассписания, меня завут P.I.B(пиб) - все названия и вся кринжовость текста связанная с моим создателем я думаю ты его знаешь). Я вижу тебя первый раз, так что давай для начала узнаем как мне тебя называть. Мой создатель назвал себя хер и я его теперь пеостоянно так назваю. Не будь как этот конч и давай ка придумай что-нибудь прикольное. ')
        await message.reply("Напиши ник")
        # Ожидание сообщения с ником
        await message.reply(f'{user_nick.text} давай подумаем, а зачем нам вообще нужно планировать? Ведь если подумать — ты каждый день тратишь определённое время на написание плана на день, и появляется вопрос — а зачем это надо? Но мой создатель неплохо так изучил этот вопрос и, главное, проверил планирование в жизни. Если не веришь этому "херу с горы", то послушай 100 роликов (которые он посмотрел) и убедись в этом.\n1.Те 5 минут, которые ты тратишь на составление плана, спасают тебя от суеты посреди дня. Сам подумай, когда тебе легче: когда ты знаешь, что тебе нужно сделать с утра, и, сделав одно, переходишь к другому? Или ты проснулся, думаешь, что тебе надо сделать, сделал это, а потом опять думаешь, и так далее? И при этом поверь мне, ты суетишься, и это отнимает в десятки раз больше времени, чем 5 минут.\n2.Ты можешь думать: Я такая свободная личность, мне бы летать, а я сам себя в клетку сажаю? Нет, тебе так кажется. План как раз освобождает тебя. Ты же знаешь, что "Делу время, а потехе час". Так вот, если ты чётко поставь делу время, то, во-первых, сократишь его, а во-вторых, ты точно будешь знать, когда настанет время для "потехи". В итоге на залипание в стену будет больше времени.\n3.Само дисциплина. Очень полезный навык. Как он работает? Да вот как: когда ты сам написал себе план, будь добр его выполнить. Пусть твоё слово что-то значит. Ты оцениваешь свои возможности, ты ставишь приоритеты, и ты управляешь временем, а не наоборот.На самом деле, очень много плюсов. Если ты хочешь узнать больше, то спроси у "хера с горы", который меня создал.')
        
    else:
        await message.reply(f"Еу, {user_name}! Я твой бот для рассписания, меня завут P.I.B(пиб) - все названия и вся кринжовость текста связанная с моим создателем я думаю ты его знаешь). Чем могу помочь?")

# Обработчик команды /help
@dp.message(Command('help'))
async def help_command(message: types.Message):
    await message.reply("Доступные команды:\n"
                       "/start - Начать работу с ботом\n"
                       "/choose_plan - Выбрать или изменить план\n"
                       "/info - Получить информацию о планировании\n"
                       "/help - Показать это сообщение")
                       
# Обработчик команды для выбора плана
@dp.message(Command('choose_plan'))
async def choose_plan_command(message: types.Message):
    user_id = message.from_user.id
    current_plan = get_user_plan(user_id)

    if current_plan:
        await message.reply(f"У вас уже выбран план: {current_plan}. Хотите его изменить? (да/нет)")
    else:
        await message.reply("Выберите вид плана:\n1. Lite\n2. Med\n3. Hard\nНапишите 1, 2 или 3.")


# Обработчик текстовых сообщений для выбора плана
@dp.message()
async def handle_plan_selection(message: types.Message):
    user_id = message.from_user.id
    current_plan = get_user_plan(user_id)

    if message.text in ['1', '2', '3']:
        plan_types = { '1': 'lite', '2': 'med', '3': 'hard' }
        selected_plan = plan_types[message.text]

        if current_plan:
            await message.reply(f"Вы действительно хотите изменить план с {current_plan} на {selected_plan}? (да/нет)")
        else:
            save_user_plan(user_id, selected_plan)
            await message.reply(f"Вы выбрали план: {selected_plan}.")
    elif current_plan and message.text.lower() == 'да':
        save_user_plan(user_id, selected_plan)
        await message.reply(f"План успешно изменен на: {selected_plan}.")
    elif current_plan and message.text.lower() == 'нет':
        await message.reply("Вы оставили текущий план без изменений.")
    else:
        await message.reply("Пожалуйста, выберите 1, 2 или 3 для выбора плана.")

# Обработчик команды /info
@dp.message(Command('info'))
async def info_command(message: types.Message):
    user_id = message.from_user.id
    user_name = get_user_name(user_id)
    
    if user_name is None:
        await message.reply('Ваше имя еще не установлено. Пожалуйста, используйте команду /start, чтобы ввести его.')
    else:
        await message.reply(f'{user_name}, давай подумаем, а зачем нам вообще нужно планировать? Ведь если подумать — ты каждый день тратишь определённое время на написание плана на день, и появляется вопрос — а зачем это надо? Но мой создатель неплохо так изучил этот вопрос и, главное, проверил планирование в жизни. Если не веришь этому "херу с горы", то послушай 100 роликов (которые он посмотрел) и убедись в этом.\n\n1.  Те 5 минут, которые ты тратишь на составление плана, спасают тебя от суеты посреди дня. Сам подумай, когда тебе легче: когда ты знаешь, что тебе нужно сделать с утра, и, сделав одно, переходишь к другому? Или ты проснулся, думаешь, что тебе надо сделать, сделал это, а потом опять думаешь, и так далее? И при этом поверь мне, ты суетишься, и это отнимает в десятки раз больше времени, чем 5 минут.\n\n2.  Ты можешь думать: Я такая свободная личность, мне бы летать, а я сам себя в клетку сажаю? Нет, тебе так кажется. План как раз освобождает тебя. Ты же знаешь, что "Делу время, а потехе час". Так вот, если ты чётко поставь делу время, то, во-первых, сократишь его, а во-вторых, ты точно будешь знать, когда настанет время для "потехи". В итоге на залипание в стену будет больше времени.\n\n3.  Само дисциплина. Очень полезный навык. Как он работает? Да вот как: когда ты сам написал себе план, будь добр его выполнить. Пусть твоё слово что-то значит. Ты оцениваешь свои возможности, ты ставишь приоритеты, и ты управляешь временем, а не наоборот.На самом деле, очень много плюсов. Если ты хочешь узнать больше, то спроси у "хера с горы", который меня создал.')



# Функция запуска бота
async def main():
    print('Бот запущен...')
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main()) 